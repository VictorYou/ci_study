apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gerrit-etc
  namespace: ci
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: rook-nfs-share-gerrit-etc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gerrit-git
  namespace: ci
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: rook-nfs-share-gerrit-git
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gerrit-db
  namespace: ci
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: rook-nfs-share-gerrit-db
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gerrit-index
  namespace: ci
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: rook-nfs-share-gerrit-index
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gerrit-cache
  namespace: ci
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: rook-nfs-share-gerrit-cache
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gerrit
  namespace: ci
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gerrit
  template:
    metadata:
      labels:
        app: gerrit
    spec:
      initContainers:
      - name: busybox-gerrit-prepare-pvc
        image: busybox:1.30
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c", "--"]
        args: ["chmod 777 /nfs/*; for dir in etc git db index cache; do rm -rf /nfs/$dir/*; done; for file in gerrit.config secure.config; do wget https://raw.githubusercontent.com/VictorYou/ci_study/master/app_gerrit/$file -O /nfs/etc/$file ; done; for file in gerritadmin.ldif developer1.ldif; do wget https://raw.githubusercontent.com/VictorYou/ci_study/master/app_gerrit/$file -O /nfs/etc/$file; done"]
        volumeMounts:
        - name: gerrit-etc
          mountPath: /nfs/etc
        - name: gerrit-git
          mountPath: /nfs/git
        - name: gerrit-db
          mountPath: /nfs/db
        - name: gerrit-index
          mountPath: /nfs/index
        - name: gerrit-cache
          mountPath: /nfs/cache
      - name: busybox-gerrit-create-entry
        image: osixia/openldap:1.4.0
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c", "--"]
        args: ["for file in gerritadmin.ldif developer1.ldif; do  ldapadd -x -H ldap://myldap -D cn=admin,dc=example,dc=org -w secret -f /nfs/etc/$file; done"]
        volumeMounts:
        - name: gerrit-etc
          mountPath: /nfs/etc
      containers:
      - name: gerrit
        image: gerritcodereview/gerrit:3.2.3
        imagePullPolicy: IfNotPresent
        env:
        - name: CANONICAL_WEB_URL
          value: http://localhost
        ports:
        - containerPort: 29418
        - containerPort: 8080
        volumeMounts:
        - name: gerrit-etc
          mountPath: /var/gerrit/etc
        - name: gerrit-git
          mountPath: /var/gerrit/git
        - name: gerrit-db
          mountPath: /var/gerrit/db
        - name: gerrit-index
          mountPath: /var/gerrit/index
        - name: gerrit-cache
          mountPath: /var/gerrit/cache
      volumes:
      - name: gerrit-etc
        persistentVolumeClaim:
          claimName: gerrit-etc
          readOnly: false
      - name: gerrit-git
        persistentVolumeClaim:
          claimName: gerrit-git
          readOnly: false
      - name: gerrit-db
        persistentVolumeClaim:
          claimName: gerrit-db
          readOnly: false
      - name: gerrit-index
        persistentVolumeClaim:
          claimName: gerrit-index
          readOnly: false
      - name: gerrit-cache
        persistentVolumeClaim:
          claimName: gerrit-cache
          readOnly: false
---
apiVersion: v1
kind: Service
metadata:
  name: gerrit
  namespace: ci
  labels:
    app: gerrit
spec:
  type: NodePort
  ports:
  - name: ssh
    port: 29418
    targetPort: 29418
    nodePort: 32418
  - name: http
    port: 80 
    targetPort: 8080
    nodePort: 32080
  selector:
    app: gerrit
